<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnyHA - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary-color: #00ffc3; --secondary-color: #a972ff; --background-dark: #1a1a2e; --text-light: #e0e0e0; --text-dark: #333; --glass-bg: rgba(255, 255, 255, 0.1); --glass-border: rgba(255, 255, 255, 0.2); --shadow-color: rgba(31, 38, 135, 0.37); --danger-color: #ef5350; --success-color: #66bb6a; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #161623; color: var(--text-light); }
        .mobile-container { width: 375px; height: 812px; background: var(--background-dark); border-radius: 40px; box-shadow: 0 15px 50px rgba(0,0,0,0.5); overflow: hidden; position: relative; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; margin-bottom: 20px; }
        .btn-primary, .btn-secondary { width: 100%; padding: 15px; border: none; border-radius: 15px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: var(--text-dark); }
        .btn-secondary { background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-light); margin-top:10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display:block; margin-bottom:5px; opacity:0.8; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 10px; color: var(--text-light); }
        .main-app { height:100%; display:flex; flex-direction:column; }
        #main-content { flex-grow: 1; padding: 0 20px 20px; overflow-y: auto; scrollbar-width: none; }
        #main-content::-webkit-scrollbar { display: none; }
        .bottom-nav { display: flex; padding: 10px 0; margin: 0 20px 10px; border-radius: 25px; }
        .nav-button { flex: 1; background: none; border: none; color: var(--text-light); display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .nav-button i { font-size: 22px; }
        .nav-button.active { color: var(--primary-color); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: var(--background-dark); border: 1px solid var(--glass-border); width: 90%; max-width: 400px; max-height: 80vh; border-radius: 20px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-close-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-light); border-radius: 10px; cursor: pointer; }
        .tab-btn.active { background: var(--primary-color); color: var(--text-dark); font-weight: 600; }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div id="admin-login-screen" style="padding:20px; height:100%; display:flex; flex-direction:column; justify-content:center;">
            <div class="glass-card"><h1>Admin Panel</h1><div class="form-group"><input type="email" id="admin-email" value="admin@earnyha.com"></div><div class="form-group"><input type="password" id="admin-password" placeholder="Password"></div><button id="admin-login-button" class="btn-primary">Login</button></div>
        </div>
        <div id="main-app-ui" class="main-app hidden">
            <header style="padding: 25px 20px 15px; display: flex; justify-content: space-between; align-items: center;"><h1 id="header-title"></h1><i class="fa-solid fa-sign-out-alt" id="admin-logout-button" style="cursor:pointer;"></i></header>
            <main id="main-content"></main>
            <nav class="bottom-nav glass-card">
                <button class="nav-button active" data-screen="dashboard"><i class="fas fa-tachometer-alt"></i></button>
                <button class="nav-button" data-screen="users"><i class="fas fa-users"></i></button>
                <button class="nav-button" data-screen="content"><i class="fas fa-edit"></i></button>
                <button class="nav-button" data-screen="withdrawals"><i class="fas fa-hand-holding-usd"></i></button>
            </nav>
        </div>
    </div>
    <div id="modal-container"></div>
<script>
document.addEventListener('DOMContentLoaded', () => {

    // 1. FIREBASE CONFIG (Aapka config yahan daal diya gaya hai)
    const firebaseConfig = {
      apiKey: "AIzaSyAvOCamAwrk7yg-I6RVuMfzE_vKbZlAwwo",
      authDomain: "earnyha-app.firebaseapp.com",
      databaseURL: "https://earnyha-app-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "earnyha-app",
      storageBucket: "earnyha-app.firebasestorage.app",
      messagingSenderId: "117222358496",
      appId: "1:117222358496:web:40ef494c898fea61ebff85",
      measurementId: "G-ME6C5D883Z"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 2. DOM & STATE
    const dom = { login: document.getElementById('admin-login-screen'), app: document.getElementById('main-app-ui'), main: document.getElementById('main-content'), header: document.getElementById('header-title'), modal: document.getElementById('modal-container'), nav: document.querySelector('.bottom-nav') };
    const appState = { allUsers: [], allTasks: [], allGames: [], currentEditing: { type: null, id: null } };

    // 3. AUTH
    auth.onAuthStateChanged(user => {
        if (user) { // Simple check, rules will enforce admin status
            dom.app.classList.remove('hidden');
            dom.login.classList.add('hidden');
            renderScreen('dashboard');
        } else {
            dom.app.classList.add('hidden');
            dom.login.classList.remove('hidden');
        }
    });
    document.getElementById('admin-login-button').addEventListener('click', async () => { try { await auth.signInWithEmailAndPassword(document.getElementById('admin-email').value, document.getElementById('admin-password').value); } catch(e) { alert(e.message); }});
    document.getElementById('admin-logout-button').addEventListener('click', () => auth.signOut());

    // 4. NAVIGATION
    dom.nav.addEventListener('click', e => { if(e.target.closest('.nav-button')) renderScreen(e.target.closest('.nav-button').dataset.screen) });

    function renderScreen(screenId){
        dom.header.textContent = screenId.charAt(0).toUpperCase() + screenId.slice(1);
        dom.nav.querySelector('.active')?.classList.remove('active');
        dom.nav.querySelector(`[data-screen=${screenId}]`).classList.add('active');
        dom.main.innerHTML = `<div style="display: flex; justify-content: center; padding: 40px;"><div class="spinner" style="width: 40px; height: 40px; border: 4px solid var(--glass-border); border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;"></div></div>`;

        const screenRenderers = { dashboard: renderDashboard, users: renderUsers, content: renderContent, withdrawals: renderWithdrawals };
        if(screenRenderers[screenId]) screenRenderers[screenId]();
    }
    
    // 5. SCREEN RENDERERS
    async function renderDashboard(){
        const [users, withdrawals, tasks, games] = await Promise.all([db.collection('users').get(), db.collection('withdrawals').where('status','==','pending').get(), db.collection('tasks').get(), db.collection('games').get()]);
        dom.main.innerHTML = `
            <div class="glass-card" style="text-align:center;"><p style="font-size:32px;">${users.size}</p><p>Total Users</p></div>
            <div class="glass-card" style="text-align:center;"><p style="font-size:32px;">${withdrawals.size}</p><p>Pending Withdrawals</p></div>
            <div class="glass-card" style="text-align:center;"><p style="font-size:32px;">${tasks.size}</p><p>Total Tasks</p></div>
            <div class="glass-card" style="text-align:center;"><p style="font-size:32px;">${games.size}</p><p>Total Games</p></div>`;
    }
    
    async function renderUsers(){
        const snapshot = await db.collection('users').get();
        appState.allUsers = snapshot.docs.map(doc => ({id: doc.id, ...doc.data() }));
        const userCardsHTML = appState.allUsers.map(user => `
            <div class="glass-card user-card" data-name="${user.username.toLowerCase()}" data-email="${user.email.toLowerCase()}" style="display:flex; justify-content:space-between; align-items:center; padding:15px;">
                <div><p><strong>${user.username}</strong></p><p style="font-size:12px; opacity:0.7;">Balance: ₹${user.balance.toFixed(2)}</p></div>
                <button class="btn-secondary" style="width:auto; padding:8px 15px; margin:0;" onclick="openUserModal('${user.id}')">View</button>
            </div>`).join('');
        dom.main.innerHTML = `<input type="search" id="user-search-input" placeholder="Search users..." style="width: 100%; margin-bottom: 20px; padding: 12px; border-radius:10px; background:rgba(0,0,0,0.2); border:1px solid var(--glass-border); color:white;">${userCardsHTML}`;
        document.getElementById('user-search-input').addEventListener('input', e => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.user-card').forEach(card => card.classList.toggle('hidden', !card.dataset.name.includes(searchTerm) && !card.dataset.email.includes(searchTerm)));
        });
    }
    
    async function renderContent(activeTab = 'tasks'){
        const [tasks, games, announcements] = await Promise.all([
            db.collection('tasks').orderBy('createdAt','desc').get(),
            db.collection('games').orderBy('createdAt','desc').get(),
            db.collection('announcements').orderBy('createdAt','desc').limit(5).get()
        ]);
        appState.allTasks = tasks.docs.map(d=>({id: d.id, ...d.data()}));
        appState.allGames = games.docs.map(d=>({id: d.id, ...d.data()}));

        const tasksHTML = appState.allTasks.map(t => `<div class="glass-card" style="padding:15px;"><p><strong>${t.name}</strong><br>Reward: ₹${t.reward}</p><button onclick="openContentModal('task','${t.id}')">Edit</button> <button onclick="deleteContent('tasks','${t.id}')">Delete</button></div>`).join('');
        const gamesHTML = appState.allGames.map(g => `<div class="glass-card" style="padding:15px;"><p><strong>${g.name}</strong><br>Reward/Min: ₹${g.rewardPerMinute}</p><button onclick="openContentModal('game','${g.id}')">Edit</button> <button onclick="deleteContent('games','${g.id}')">Delete</button></div>`).join('');
        const announcementsHTML = announcements.docs.map(a => `<p style="padding:5px; border-bottom:1px solid var(--glass-border);">${a.data().message}</p>`).join('');

        dom.main.innerHTML = `
            <div class="glass-card"><h3>Send Announcement</h3><textarea id="announcement-text" placeholder="New announcement..."></textarea><button class="btn-primary" style="margin-top:10px;" onclick="handleAnnouncement()">Send</button><h4>Recent:</h4>${announcementsHTML}</div>
            <div class="tab-buttons"><button class="tab-btn ${activeTab === 'tasks' ? 'active' : ''}" onclick="renderContent('tasks')">Tasks</button><button class="tab-btn ${activeTab === 'games' ? 'active' : ''}" onclick="renderContent('games')">Games</button></div>
            <div id="content-display"></div>
            <button class="btn-primary" onclick="openContentModal('${activeTab}')">Add New ${activeTab === 'tasks' ? 'Task' : 'Game'}</button>`;
        document.getElementById('content-display').innerHTML = activeTab === 'tasks' ? tasksHTML : gamesHTML;
    }
    
    async function renderWithdrawals(){ /* same as V3 */ }
    
    // 6. MODAL & FORM HANDLERS
    window.openUserModal = (userId) => { /* same as V3 */ };
    window.openContentModal = (type, id = null) => {
        appState.currentEditing = { type, id };
        const isTask = type === 'task';
        const data = id ? (isTask ? appState.allTasks : appState.allGames).find(item => item.id === id) : {};
        
        dom.modal.innerHTML = `
        <div class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header"><h3>${id ? 'Edit' : 'Add'} ${type}</h3><button class="modal-close-btn" onclick="closeModal()">×</button></div>
                <div class="modal-body">
                    <div class="form-group"><label>Name</label><input id="content-name" value="${data.name || ''}"></div>
                    <div class="form-group"><label>Description</label><input id="content-desc" value="${data.description || ''}"></div>
                    <div class="form-group"><label>Image URL</label><input id="content-image" value="${data.imageUrl || ''}"></div>
                    <div class="form-group"><label>${isTask ? 'Button URL' : 'Game URL'}</label><input id="content-url" value="${data[isTask ? 'buttonUrl' : 'gameUrl'] || ''}"></div>
                    <div class="form-group"><label>${isTask ? 'Reward' : 'Reward/Min'}</label><input id="content-reward" type="number" value="${data[isTask ? 'reward' : 'rewardPerMinute'] || ''}"></div>
                    <button class="btn-primary" onclick="handleContentFormSubmit()">Save</button>
                </div>
            </div>
        </div>`;
    };
    window.closeModal = () => dom.modal.innerHTML = '';
    
    // 7. ACTION HANDLERS
    window.adjustBalance = async (userId) => { /* same as V3 */ };
    window.handleAnnouncement = async () => { /* same as V3 */ };
    window.handleWithdrawal = async (reqId, isApproved, userId, amount) => { /* same as V3 */ };
    
    window.handleContentFormSubmit = async () => {
        const { type, id } = appState.currentEditing;
        const isTask = type === 'task';
        const data = {
            name: document.getElementById('content-name').value,
            description: document.getElementById('content-desc').value,
            imageUrl: document.getElementById('content-image').value,
            [isTask ? 'buttonUrl' : 'gameUrl']: document.getElementById('content-url').value,
            [isTask ? 'reward' : 'rewardPerMinute']: parseFloat(document.getElementById('content-reward').value) || 0,
        };
        if(!data.name || !data.imageUrl) return alert('Name and Image URL are required.');

        if(id) {
            await db.collection(type + 's').doc(id).update(data);
        } else {
            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            await db.collection(type + 's').add(data);
        }
        alert('Saved successfully!');
        closeModal();
        renderContent(type);
    };

    window.deleteContent = async (collection, id) => {
        if(!confirm('Are you sure you want to delete this?')) return;
        await db.collection(collection).doc(id).delete();
        alert('Deleted successfully!');
        renderContent(collection.slice(0, -1));
    };
});
</script>
</body>
</html>
