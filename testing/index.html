<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>EarnyHA Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #343a40;
            --text-light: #6c757d;
            --border-color: #dee2e6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #e9ecef; color: var(--text-color); }

        /* --- LOGIN SCREEN --- */
        #admin-login-screen {
            display: flex; justify-content: center; align-items: center; height: 100vh;
            background: linear-gradient(45deg, #0f2027, #203a43, #2c5364);
        }
        .login-container { width: 90%; max-width: 400px; padding: 30px; background-color: var(--card-bg); border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .login-container h1 { font-size: 24px; margin-bottom: 10px; }
        .login-container p { font-size: 14px; color: var(--text-light); margin-bottom: 25px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; }
        .btn { display: inline-block; padding: 12px 20px; border-radius: 8px; border: none; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.2s ease; text-align: center; width: 100%; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); }
        .btn:disabled { background-color: #a9a9a9; cursor: not-allowed; }

        /* --- MOBILE APP LAYOUT --- */
        #admin-panel {
            display: none;
            position: fixed;
            inset: 0;
            background-color: var(--bg-color);
            flex-direction: column;
        }
        .admin-app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: var(--card-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }
        .admin-app-header h1 { font-size: 20px; font-weight: 600; }
        #admin-logout-button { background: none; border: none; font-size: 22px; color: var(--danger-color); cursor: pointer; }
        
        #page-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 80px; /* Space for bottom nav */
        }

        /* --- BOTTOM NAVIGATION --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 65px;
            background-color: var(--card-bg);
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
            border-top: 1px solid var(--border-color);
        }
        .nav-button {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .nav-button i { font-size: 22px; margin-bottom: 4px; }
        .nav-button span { font-size: 12px; font-weight: 500; }
        .nav-button.active { color: var(--primary-color); }

        /* --- CONTENT STYLES --- */
        .page-title { font-size: 24px; font-weight: 600; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { background-color: var(--card-bg); padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .stat-card h3 { font-size: 24px; font-weight: 700; }
        .stat-card p { font-size: 12px; color: var(--text-light); font-weight: 500; }

        .list-item-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .item-info h4 { font-size: 16px; font-weight: 600; }
        .item-info p { font-size: 14px; color: var(--text-light); }
        .item-info .amount { color: var(--success-color); font-weight: 600; }
        
        .item-actions .btn-sm { padding: 6px 12px; font-size: 14px; width: auto; margin-left: 5px; border-radius: 6px; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: white; }
        
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .section-header h2 { font-size: 18px; font-weight: 600; }
        .btn-add { background-color: var(--primary-color); color: white; border-radius: 50%; width: 40px; height: 40px; font-size: 18px; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); }

        .placeholder { text-align: center; padding: 40px; color: var(--text-light); }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; z-index: 1000; inset: 0; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--card-bg); width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: slide-in 0.3s ease-out; display: flex; flex-direction: column; max-height: 90vh; }
        @keyframes slide-in { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 15px; border-bottom: 1px solid var(--border-color); }
        .modal-header h2 { font-size: 18px; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 15px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid var(--border-color); }
        .btn-secondary { background-color: var(--border-color); color: var(--text-color); }
    </style>
</head>
<body>

    <!-- ======== ADMIN LOGIN SCREEN ======== -->
    <div id="admin-login-screen">
        <div class="login-container">
            <h1>Admin Panel</h1><p>Sign in to manage EarnyHA</p>
            <form id="admin-login-form">
                <div class="form-group"><label for="admin-email">Email</label><input type="email" id="admin-email" required></div>
                <div class="form-group"><label for="admin-password">Password</label><input type="password" id="admin-password" required></div>
                <button type="submit" class="btn btn-primary" id="admin-login-button">Sign In</button>
            </form>
        </div>
    </div>

    <!-- ======== MOBILE ADMIN PANEL ======== -->
    <div id="admin-panel">
        <header class="admin-app-header">
            <h1 id="page-title-header">Dashboard</h1>
            <button id="admin-logout-button"><i class="fas fa-sign-out-alt"></i></button>
        </header>

        <main id="page-content">
            <!-- All pages will be rendered here by JavaScript -->
        </main>

        <nav class="bottom-nav">
            <button class="nav-button active" data-page="dashboard"><i class="fas fa-tachograph-alt"></i><span>Dashboard</span></button>
            <button class="nav-button" data-page="users"><i class="fas fa-users"></i><span>Users</span></button>
            <button class="nav-button" data-page="withdrawals"><i class="fas fa-wallet"></i><span>Withdrawals</span></button>
            <button class="nav-button" data-page="tasks"><i class="fas fa-tasks"></i><span>Tasks</span></button>
            <button class="nav-button" data-page="games"><i class="fas fa-gamepad"></i><span>Games</span></button>
        </nav>
    </div>

    <!-- ======== MODAL for Adding/Editing ======== -->
    <div id="form-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modal-title">Add Item</h2></div>
            <form id="modal-form">
                <div class="modal-body">
                    <input type="hidden" id="edit-item-id">
                    <input type="hidden" id="edit-item-type">
                    <div class="form-group"><label for="item-name">Name</label><input type="text" id="item-name" required></div>
                    <div class="form-group"><label for="item-description">Description</label><textarea id="item-description" required></textarea></div>
                    <div class="form-group"><label for="item-reward">Reward Amount (₹)</label><input type="number" id="item-reward" step="0.01" required></div>
                    <div class="form-group"><label for="item-url">URL (Link to task/game)</label><input type="url" id="item-url" required></div>
                    <div class="form-group"><label for="item-image-url">Image URL</label><input type="url" id="item-image-url" required></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="modal-cancel-btn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="save-item-button">Save</button>
                </div>
            </form>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- FIREBASE CONFIG ---
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAvOCamAwrk7yg-I6RVuMfzE_vKbZlAwwo",
  authDomain: "earnyha-app.firebaseapp.com",
  databaseURL: "https://earnyha-app-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "earnyha-app",
  storageBucket: "earnyha-app.firebasestorage.app",
  messagingSenderId: "117222358496",
  appId: "1:117222358496:web:40ef494c898fea61ebff85",
  measurementId: "G-ME6C5D883Z"
};
    // Initialize Firebase if not already initialized
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- DOM ELEMENTS ---
    const loginScreen = document.getElementById('admin-login-screen');
    const adminPanel = document.getElementById('admin-panel');
    const loginForm = document.getElementById('admin-login-form');
    const loginButton = document.getElementById('admin-login-button');
    const logoutButton = document.getElementById('admin-logout-button');
    const pageContent = document.getElementById('page-content');
    const pageTitleHeader = document.getElementById('page-title-header');
    const navButtons = document.querySelectorAll('.nav-button');
    const formModal = document.getElementById('form-modal');
    
    // --- STATE & DATA CACHE ---
    let currentAdmin = null;
    let unsubscribes = [];
    let dataCache = {
        users: [],
        withdrawals: [],
        tasks: [],
        games: []
    };

    // --- AUTHENTICATION ---
    auth.onAuthStateChanged(user => {
        if (user) {
            user.getIdTokenResult(true).then(idTokenResult => { // Use true to force refresh
                if (!!idTokenResult.claims.admin) {
                    currentAdmin = user;
                    showAdminPanel(true);
                    navigateTo('dashboard');
                    attachListeners();
                } else {
                    alert('Access Denied: You are not an administrator.');
                    auth.signOut();
                }
            });
        } else {
            currentAdmin = null;
            showAdminPanel(false);
            detachListeners();
        }
    });

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        loginButton.disabled = true;
        loginButton.textContent = 'Signing in...';
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-password').value;
        auth.signInWithEmailAndPassword(email, password)
            .catch(error => alert(`Login Failed: ${error.message}`))
            .finally(() => {
                loginButton.disabled = false;
                loginButton.textContent = 'Sign In';
            });
    });

    logoutButton.addEventListener('click', () => auth.signOut());

    function showAdminPanel(show) {
        loginScreen.style.display = show ? 'none' : 'flex';
        adminPanel.style.display = show ? 'flex' : 'none';
    }

    // --- REALTIME LISTENERS & DATA MANAGEMENT ---
    function attachListeners() {
        detachListeners(); // Clear old listeners first

        const collections = ['users', 'tasks', 'games'];
        collections.forEach(col => {
            let unsub = db.collection(col).onSnapshot(snap => {
                dataCache[col] = snap.docs;
                // Re-render if the user is on the current page
                const currentPage = document.querySelector('.nav-button.active')?.dataset.page;
                if (currentPage === col || currentPage === 'dashboard') {
                    navigateTo(currentPage);
                }
            });
            unsubscribes.push(unsub);
        });
        
        // Specific listener for pending withdrawals
        let unsub = db.collection('withdrawals').where('status', '==', 'pending').orderBy('requestedAt', 'desc').onSnapshot(snap => {
            dataCache.withdrawals = snap.docs;
            const currentPage = document.querySelector('.nav-button.active')?.dataset.page;
            if (currentPage === 'withdrawals' || currentPage === 'dashboard') {
                navigateTo(currentPage);
            }
        });
        unsubscribes.push(unsub);
    }
    
    function detachListeners() {
        unsubscribes.forEach(unsub => unsub());
        unsubscribes = [];
    }
    
    // --- NAVIGATION & UI CONTROL ---
    navButtons.forEach(button => {
        button.addEventListener('click', () => {
            const page = button.dataset.page;
            navButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            navigateTo(page);
        });
    });

    function navigateTo(page) {
        pageTitleHeader.textContent = page.charAt(0).toUpperCase() + page.slice(1);
        const renderers = {
            dashboard: renderDashboardPage,
            users: renderUsersPage,
            withdrawals: renderWithdrawalsPage,
            tasks: renderTasksPage,
            games: renderGamesPage
        };
        if (renderers[page]) {
            renderers[page]();
        }
    }

    // --- PAGE RENDERERS ---
    function renderDashboardPage() {
        pageContent.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card"><h3>${dataCache.users.length}</h3><p>Total Users</p></div>
                <div class="stat-card"><h3>${dataCache.withdrawals.length}</h3><p>Pending Withdrawals</p></div>
                <div class="stat-card"><h3>${dataCache.tasks.length}</h3><p>Tasks</p></div>
                <div class="stat-card"><h3>${dataCache.games.length}</h3><p>Games</p></div>
            </div>
        `;
    }

    function renderUsersPage() {
        let content = '<div>';
        if (dataCache.users.length === 0) {
            content += '<p class="placeholder">No users found.</p>';
        } else {
            dataCache.users.forEach(doc => {
                const user = doc.data();
                content += `
                    <div class="list-item-card">
                        <div class="item-info">
                            <h4>${user.username}</h4>
                            <p>${user.email}</p>
                            <p class="amount">Balance: ₹${(user.balance || 0).toFixed(2)}</p>
                        </div>
                    </div>
                `;
            });
        }
        content += '</div>';
        pageContent.innerHTML = content;
    }

    function renderWithdrawalsPage() {
        let content = '<div>';
        if (dataCache.withdrawals.length === 0) {
            content += '<p class="placeholder">No pending withdrawals.</p>';
        } else {
            dataCache.withdrawals.forEach(doc => {
                const req = doc.data();
                content += `
                    <div class="list-item-card">
                        <div class="item-info">
                            <h4>${req.username || 'N/A'}</h4>
                            <p>${req.upiId}</p>
                            <p class="amount">Request: ₹${(req.amount || 0).toFixed(2)}</p>
                        </div>
                        <div class="item-actions">
                            <button class="btn-sm btn-success" onclick="handleWithdrawal('${doc.id}', 'approved')">Approve</button>
                            <button class="btn-sm btn-danger" onclick="handleWithdrawal('${doc.id}', 'rejected')">Reject</button>
                        </div>
                    </div>
                `;
            });
        }
        content += '</div>';
        pageContent.innerHTML = content;
    }
    
    function renderGenericListPage(pageType, addBtnHandler) {
        let content = `
            <div class="section-header">
                <h2>All ${pageType}</h2>
                <button class="btn-add" onclick="${addBtnHandler}"><i class="fas fa-plus"></i></button>
            </div>
        `;
        const data = dataCache[pageType.toLowerCase()];
        if (data.length === 0) {
            content += `<p class="placeholder">No ${pageType} found.</p>`;
        } else {
            data.forEach(doc => {
                const item = doc.data();
                const reward = item.reward !== undefined ? item.reward : item.rewardPerMinute;
                content += `
                    <div class="list-item-card">
                        <div class="item-info">
                            <h4>${item.name}</h4>
                            <p>Reward: ₹${(reward || 0).toFixed(2)}</p>
                        </div>
                        <div class="item-actions">
                            <button class="btn-sm btn-warning" onclick="editItem('${doc.id}', '${pageType.slice(0, -1)}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-sm btn-danger" onclick="deleteItem('${doc.id}', '${pageType.slice(0, -1)}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }
        pageContent.innerHTML = content;
    }

    function renderTasksPage() { renderGenericListPage('Tasks', 'showModalForNew(\'task\')'); }
    function renderGamesPage() { renderGenericListPage('Games', 'showModalForNew(\'game\')'); }

    // --- CRUD & ACTIONS (exposed to global scope for onclick) ---
    window.handleWithdrawal = async (id, status) => {
        const lowerStatus = status.toLowerCase();
        if (!confirm(`Are you sure you want to ${lowerStatus} this request?`)) return;
        
        const withdrawalRef = db.collection('withdrawals').doc(id);
        
        try {
            if (lowerStatus === 'rejected') {
                // Use a transaction to ensure the refund and status update are atomic
                await db.runTransaction(async (transaction) => {
                    const reqDoc = await transaction.get(withdrawalRef);
                    if (!reqDoc.exists) throw "Request does not exist.";
                    
                    const req = reqDoc.data();
                    const userRef = db.collection('users').doc(req.userId);
                    
                    transaction.update(userRef, {
                        balance: firebase.firestore.FieldValue.increment(req.amount)
                    });
                    transaction.update(withdrawalRef, { status: lowerStatus });
                });
                alert('Request rejected and amount refunded to user.');
            } else { // Approved
                await withdrawalRef.update({ status: lowerStatus });
                alert('Request approved successfully!');
            }
        } catch (e) {
            alert('Error processing request: ' + e.message);
            console.error(e);
        }
    };
    
    window.deleteItem = (id, type) => {
        const collectionName = type.toLowerCase() + 's';
        if (!confirm(`Are you sure you want to delete this ${type}? This action cannot be undone.`)) return;
        db.collection(collectionName).doc(id).delete()
            .then(() => alert(`${type} deleted successfully!`))
            .catch(e => alert(`Error: ${e.message}`));
    };
    
    window.editItem = (id, type) => {
        const typeLower = type.toLowerCase();
        const collectionName = typeLower + 's';
        const docRef = db.collection(collectionName).doc(id);
        docRef.get().then(doc => {
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('modal-title').textContent = `Edit ${type}`;
                document.getElementById('edit-item-id').value = id;
                document.getElementById('edit-item-type').value = typeLower;
                document.getElementById('item-name').value = data.name;
                document.getElementById('item-description').value = data.description;
                const reward = data.reward !== undefined ? data.reward : data.rewardPerMinute;
                document.getElementById('item-reward').value = reward;
                const url = data.buttonUrl !== undefined ? data.buttonUrl : data.gameUrl;
                document.getElementById('item-url').value = url;
                document.getElementById('item-image-url').value = data.imageUrl;
                formModal.style.display = 'flex';
            }
        });
    };
    
    window.showModalForNew = (type) => {
        document.getElementById('modal-form').reset();
        document.getElementById('modal-title').textContent = `Add New ${type}`;
        document.getElementById('edit-item-type').value = type;
        document.getElementById('edit-item-id').value = ''; // Ensure ID is cleared
        formModal.style.display = 'flex';
    };
    
    document.getElementById('modal-cancel-btn').addEventListener('click', () => {
        formModal.style.display = 'none';
    });
    
    document.getElementById('modal-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-item-id').value;
        const type = document.getElementById('edit-item-type').value;
        const collectionName = type + 's';
        
        const data = {
            name: document.getElementById('item-name').value,
            description: document.getElementById('item-description').value,
            imageUrl: document.getElementById('item-image-url').value,
        };
        
        if (type === 'task') {
            data.reward = parseFloat(document.getElementById('item-reward').value);
            data.buttonUrl = document.getElementById('item-url').value;
        } else { // game
            data.rewardPerMinute = parseFloat(document.getElementById('item-reward').value);
            data.gameUrl = document.getElementById('item-url').value;
        }

        let promise;
        if (id) { // Editing existing
            promise = db.collection(collectionName).doc(id).update(data);
        } else { // Creating new
            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            promise = db.collection(collectionName).add(data);
        }

        promise.then(() => {
            formModal.style.display = 'none';
            alert(`${type} saved successfully!`);
        }).catch(err => alert(`Error: ${err.message}`));
    });

});
</script>

</body>
</html>
