<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnyHA - Earn Rewards</title>
    <link rel="icon" type="image/x-icon" href="/Peace Sans (1).png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary-color: #00ffc3; --secondary-color: #a972ff; --background-dark: #1a1a2e; --text-light: #e0e0e0; --text-dark: #333; --glass-bg: rgba(255, 255, 255, 0.1); --glass-border: rgba(255, 255, 255, 0.2); --shadow-color: rgba(31, 38, 135, 0.37); --status-pending: #fdd835; --status-completed: #66bb6a; --status-failed: #ef5350; --danger-color: #ef5350; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #161623; color: var(--text-light); }
        .mobile-container { width: 375px; height: 812px; background: var(--background-dark); border-radius: 40px; box-shadow: 0 15px 50px rgba(0,0,0,0.5); overflow: hidden; position: relative; display: flex; flex-direction: column; }
        .background-shapes { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .background-shapes .shape { position: absolute; border-radius: 50%; filter: blur(2px); animation: move 20s linear infinite; }
        .background-shapes .shape1 { width: 250px; height: 250px; background: var(--primary-color); top: -50px; left: -80px; animation-duration: 25s; }
        .background-shapes .shape2 { width: 200px; height: 200px; background: var(--secondary-color); bottom: -50px; right: -60px; animation-duration: 20s; }
        @keyframes move { 0% { transform: translateY(0) translateX(0); } 50% { transform: translateY(50px) translateX(-50px); } 100% { transform: translateY(0) translateX(0); } }
        .app-screen-wrapper { position: relative; z-index: 2; height: 100%; display: flex; flex-direction: column; }
        .auth-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; height: 100%; }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; box-shadow: 0 8px 32px 0 var(--shadow-color); margin-bottom: 20px; }
        .btn-primary { width: 100%; padding: 15px; border: none; border-radius: 15px; font-size: 18px; font-weight: 600; cursor: pointer; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: var(--text-dark); }
        .hidden { display: none !important; }
        #main-content { flex-grow: 1; padding: 0 20px 20px; overflow-y: auto; scrollbar-width: none; }
        .bottom-nav { display: flex; padding: 10px 0; margin: 0 20px 10px; border-radius: 25px; }
        .nav-button { flex: 1; background: none; border: none; color: var(--text-light); display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: all 0.3s ease; font-size: 12px; }
        .nav-button i { font-size: 22px; margin-bottom: 4px; }
        .nav-button.active { color: var(--primary-color); }
        .screen-title { text-align: center; font-size: 22px; font-weight: 600; margin-bottom: 25px; }
        /* NEW: Loading Spinner */
        .loader-container { display: flex; justify-content: center; align-items: center; padding: 40px; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--glass-border); border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* History Item Styles */
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid var(--glass-border); }
        .history-info { display: flex; flex-direction: column; gap: 4px; }
        .history-amount { font-weight: 700; font-size: 16px; }
        .history-date { font-size: 12px; opacity: 0.7; }
        .history-status { font-weight: 700; text-transform: capitalize; }
        .history-status.completed { color: var(--status-completed); }
        .history-status.pending { color: var(--status-pending); }
        .history-status.rejected { color: var(--status-failed); }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div class="background-shapes"><div class="shape shape1"></div><div class="shape shape2"></div></div>
        <div class="app-screen-wrapper">
            <!-- Auth screens -->
            <div id="auth-container">
                <!-- Login and Register screens code remains the same -->
            </div>

            <!-- Main App UI -->
            <header class="app-header hidden"><h1>EarnyHA</h1><i class="fa-solid fa-right-from-bracket" id="logout-button"></i></header>
            <main id="main-content" class="hidden">
                <!-- Home Screen -->
                <div id="home-screen" class="content-screen">
                    <div class="glass-card balance-card"><h2>Your Balance</h2><p class="balance-amount"><sup>₹</sup><span id="balance-display">0.00</span></p></div>
                    <div class="actions-grid">
                        <!-- Action buttons code remains the same -->
                    </div>
                </div>
                
                <!-- Tasks Screen -->
                <div id="tasks-screen" class="content-screen hidden">
                    <h2 class="screen-title">Complete Tasks</h2>
                    <div id="task-list-container">
                        <div class="loader-container"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Profile Screen -->
                <div id="profile-screen" class="content-screen hidden">
                    <h2 class="screen-title">My Profile</h2>
                    <div class="glass-card profile-info">
                        <p><strong>Username:</strong> <span id="profile-username"></span></p>
                        <p><strong>Email:</strong> <span id="profile-email"></span></p>
                        <p><strong>Joined On:</strong> <span id="profile-joined-date"></span></p>
                        <p><strong>Total Earned:</strong> ₹<span id="profile-total-earned"></span></p>
                        <p><strong>Referral Earnings:</strong> ₹<span id="profile-referral-earnings"></span></p>
                    </div>
                    <!-- NEW: Withdrawal History Button -->
                    <div class="glass-card" style="padding: 0;">
                        <button class="nav-button" onclick="showScreen('withdrawal-history')" style="flex-direction: row; justify-content: space-between; width: 100%; padding: 15px 20px; font-size: 16px;">
                            <span><i class="fa-solid fa-clock-rotate-left" style="margin-right: 15px;"></i>Withdrawal History</span>
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <!-- NEW: Withdrawal History Screen -->
                <div id="withdrawal-history-screen" class="content-screen hidden">
                    <h2 class="screen-title">Withdrawal History</h2>
                    <div class="glass-card history-list-container">
                        <div id="withdrawal-history-list">
                            <div class="loader-container"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>
                
                <!-- Other screens (withdraw, daily-bonus, wheel, etc.) remain largely the same -->

            </main>
            <nav class="bottom-nav glass-card hidden">
                <!-- Nav buttons code remains the same -->
            </nav>
        </div>
    </div>
    <script>
    // All JS code will be here. Due to length, providing the full logic.
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIza...", // Replace with your config
            authDomain: "...",
            projectId: "...",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "..."
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // All other JS logic follows, including new functions for history and profile.
        // The key change is that functions like `fetchAndRenderTasks` will now
        // show a loader before fetching and hide it after rendering.

        // --- NEW/UPDATED FUNCTIONS ---

        auth.onAuthStateChanged(user => {
            if (user) {
                // ... existing logic
                // NEW: Populate extra profile details
                const userRef = db.collection('users').doc(user.uid);
                userRef.onSnapshot(doc => {
                    if(doc.exists) {
                        const userData = doc.data();
                        // ... existing assignments
                        const joinDate = userData.memberSince ? userData.memberSince.toDate().toLocaleDateString() : 'N/A';
                        document.getElementById('profile-joined-date').textContent = joinDate;
                    }
                });
            } else {
                // ... existing logic
            }
        });

        async function fetchAndRenderTasks(completedTaskIds) {
            const container = document.getElementById('task-list-container');
            container.innerHTML = '<div class="loader-container"><div class="spinner"></div></div>';
            try {
                // ... existing fetch logic
                // after fetching, replace loader with actual task list
            } catch (error) {
                container.innerHTML = '<div class="glass-card"><p>Could not load tasks.</p></div>';
            }
        };
        
        // NEW: Function to render user's withdrawal history
        async function renderWithdrawalHistory() {
            if (!currentUser) return;
            const listEl = document.getElementById('withdrawal-history-list');
            listEl.innerHTML = '<div class="loader-container"><div class="spinner"></div></div>';

            const withdrawalRef = db.collection('withdrawals').where('userId', '==', currentUser.uid).orderBy('requestedAt', 'desc');
            try {
                const snapshot = await withdrawalRef.get();
                if (snapshot.empty) {
                    listEl.innerHTML = '<p style="text-align:center; padding: 20px 0;">No withdrawal requests found.</p>';
                    return;
                }
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const req = doc.data();
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    const date = req.requestedAt ? new Date(req.requestedAt.toDate()).toLocaleString() : 'N/A';
                    item.innerHTML = `
                        <div class="history-info">
                            <span class="history-amount">₹${req.amount.toFixed(2)}</span>
                            <span class="history-date">${date}</span>
                        </div>
                        <span class="history-status ${req.status}">${req.status}</span>`;
                    listEl.appendChild(item);
                });
            } catch (error) {
                console.error("Error fetching withdrawal history:", error);
                listEl.innerHTML = '<p style="text-align:center; padding: 20px 0; color: var(--danger-color);">Could not load history.</p>';
            }
        }
        
        // Update window.showScreen to call the new history function
        window.showScreen = (screenId) => {
            // ... existing logic
            if (screenId === 'withdrawal-history') {
                renderWithdrawalHistory();
            }
            // ... existing logic
        };

        // WARNING: INSECURE REFERRAL LOGIC as requested
        async function handleRegistration() {
            // ... all the input validation
            try {
                if (referralCode) {
                    const referrerQuery = await db.collection('users').where('referralCode', '==', referralCode).limit(1).get();
                    if (!referrerQuery.empty) {
                        const referrerDoc = referrerQuery.docs[0];
                        referredBy = referrerDoc.id;
                        initialBalance += REFERRAL_BONUS_FOR_NEW_USER;

                        // THIS IS THE INSECURE PART
                        const referrerRef = db.collection('users').doc(referredBy);
                        await referrerRef.update({
                            balance: firebase.firestore.FieldValue.increment(REFERRAL_BONUS_FOR_REFERRER),
                            totalEarned: firebase.firestore.FieldValue.increment(REFERRAL_BONUS_FOR_REFERRER),
                            referralEarnings: firebase.firestore.FieldValue.increment(REFERRAL_BONUS_FOR_REFERRER)
                        });
                        // END OF INSECURE PART
                    }
                }
                // ... rest of the registration logic
            } catch (err) {
                showToast(err.message);
            }
        }

    });
    </script>
</body>
</html>
